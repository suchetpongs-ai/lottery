# ========================================
# üöÄ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Deploy ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 5 (Runtime Fix)
# ========================================
# ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏°: API crash ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Prisma Runtime ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ Database URL (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å schema)
# ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á Database URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î (PrismaService constructor)
# ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥: ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ update ‡πÅ‡∏•‡∏∞ restart

bash << 'DEPLOYEOF'
#!/bin/bash
set -e

echo "=========================================="
echo "üöÄ Deploy ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 5 - Runtime Fix"
echo "=========================================="

# 1. Update Code
echo ""
echo "üì¶ [1/4] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î..."
cd /var/www/lottery
git pull origin main

# 2. Rebuild API
echo ""
echo "üèóÔ∏è  [2/4] ‡∏Å‡∏≥‡∏•‡∏±‡∏á Rebuild API..."
cd apps/api
# Generate ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
npx prisma generate
npm run build

# 3. Restart PM2
echo ""
echo "üöÄ [3/4] ‡∏Å‡∏≥‡∏•‡∏±‡∏á Restart Services..."
pm2 restart lottery-api --update-env
pm2 restart lottery-web --update-env

# 4. Verify
echo ""
echo "‚è≥ [4/4] ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•..."
sleep 5
pm2 list
echo ""
echo "üìã API Logs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:"
pm2 logs lottery-api --lines 20 --nostream

echo ""
echo "‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡∏ñ‡πâ‡∏≤ status ‡πÄ‡∏õ‡πá‡∏ô 'online' ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ error log ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö"
echo "üëâ http://76.13.18.170"
DEPLOYEOF
