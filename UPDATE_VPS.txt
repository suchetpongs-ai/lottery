# ========================================
# üîÑ UPDATE VPS WITH LATEST CODE
# ========================================
# ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: lottery-web error ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ code ‡πÄ‡∏Å‡πà‡∏≤
# ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Pull code ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å GitHub ‡πÅ‡∏•‡∏∞ rebuild
# ========================================

# STEP 1: Pull Latest Code
cd /var/www/lottery
git pull origin main

# STEP 2: Clean Everything
rm -rf apps/api/dist apps/web/.next apps/web/node_modules/.cache node_modules

# STEP 3: Install Dependencies (‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà)
npm install
cd apps/api && npm install
cd ../web && npm install

# STEP 4: Build Backend
cd /var/www/lottery/apps/api
npm run build
ls -la dist/main.js  # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ build ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

# STEP 5: Build Frontend
cd /var/www/lottery/apps/web  
npm run build
ls -la .next  # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ build ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

# STEP 6: Restart Services
pm2 delete all

cd /var/www/lottery/apps/api
pm2 start dist/main.js --name lottery-api

cd /var/www/lottery/apps/web
pm2 start npm --name lottery-web -- start

pm2 save
pm2 list

# ========================================
# ‚úÖ Verification
# ========================================
echo "üîç Checking services..."
pm2 list

# Both should show 'online':
# lottery-api  - online ‚úÖ
# lottery-web  - online ‚úÖ

echo "üåê Testing website..."
curl http://localhost:3000

# ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á error:
# pm2 logs lottery-web --lines 50 --nostream
# pm2 logs lottery-api --lines 50 --nostream

# ========================================
# üåê Open Browser
# ========================================
# http://76.13.18.170
