# ========================================
# üêû ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Deploy ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 7 (Debug Adapter)
# ========================================
# ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á pg adapter ‡πÅ‡∏•‡∏∞ dependencies ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
# ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:
# 1. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á 'pg' ‡πÅ‡∏•‡∏∞ '@prisma/adapter-pg'
# 2. Rebuild API ‡πÉ‡∏´‡∏°‡πà

bash << 'DEPLOYEOF'
#!/bin/bash
set -e

echo "=========================================="
echo "üêû Deploy ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 7 - Adapter & Deps"
echo "=========================================="

echo ""
echo "üì¶ [1/4] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î..."
cd /var/www/lottery
git pull origin main

echo ""
echo "üßπ [2/4] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á dependencies..."
cd apps/api
# ‡∏•‡∏ö package ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡∏µ‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á adapter-pg
npm uninstall @prisma/adapter-libsql @libsql/client better-sqlite3
npm install pg @prisma/adapter-pg dotenv
# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
npm install

echo ""
echo "üèóÔ∏è  [3/4] ‡∏Å‡∏≥‡∏•‡∏±‡∏á Rebuild API..."
# ‡∏•‡∏ö cache prisma
rm -rf node_modules/.prisma
npx prisma generate
npm run build

echo ""
echo "üöÄ [4/4] ‡∏Å‡∏≥‡∏•‡∏±‡∏á Restart Services..."
pm2 restart lottery-api --update-env

echo ""
echo "‚è≥ ‡∏£‡∏≠ start 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ..."
sleep 10

echo ""
echo "üìã ‡∏î‡∏π Logs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:"
pm2 logs lottery-api --lines 30 --nostream

echo ""
echo "=========================================="
echo "‡∏´‡∏ß‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏à‡∏≠ '‚úÖ Connected' ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö!"
echo "=========================================="
DEPLOYEOF
