# ========================================
# üöÄ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Deploy ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3 (Final Fix)
# ========================================
# ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ‡πÑ‡∏ü‡∏•‡πå prisma.config.ts ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ SQLite ‡πÅ‡∏ó‡∏ô PostgreSQL
# ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå prisma.config.ts ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß
# ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥: ‡∏£‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ deploy ‡πÉ‡∏´‡∏°‡πà (‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏≤)

bash << 'DEPLOYEOF'
#!/bin/bash
set -e

echo "=========================================="
echo "üöÄ Deploy ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 3 - Final Fix"
echo "=========================================="

# ========================================
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏ö PM2 ‡πÄ‡∏Å‡πà‡∏≤
# ========================================
echo ""
echo "üìõ [1/10] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏¢‡∏∏‡∏î PM2 services ‡πÄ‡∏Å‡πà‡∏≤..."
pm2 delete all 2>/dev/null || true
pm2 kill
echo "‚úÖ ‡∏´‡∏¢‡∏∏‡∏î PM2 ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"

# ========================================
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
# ========================================
echo ""
echo "üóëÔ∏è  [2/10] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤..."
rm -rf /var/www/lottery /var/www/lottery_old
echo "‚úÖ ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"

# ========================================
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: Skip Database Reset
# ========================================
echo ""
echo "‚è≠Ô∏è  [3/10] ‡∏Ç‡πâ‡∏≤‡∏° - Database ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°"

# ========================================
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database
# ========================================
echo ""
echo "üß™ [4/10] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ PostgreSQL..."
PGPASSWORD=lottery_pass_2024 psql -U lottery_user -h localhost -d lottery_db -c "SELECT 1;" || { 
    echo "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ database ‡πÑ‡∏î‡πâ!"; 
    exit 1; 
}
echo "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ database ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"

# ========================================
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 5: Clone ‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å GitHub (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
# ========================================
echo ""
echo "üì¶ [5/10] ‡∏Å‡∏≥‡∏•‡∏±‡∏á clone repository ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å GitHub..."
cd /var/www
git clone https://github.com/suchetpongs-ai/lottery.git
cd lottery
echo "‚úÖ Clone repository ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"

# ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ prisma.config.ts ‡πÅ‡∏•‡πâ‡∏ß
if [ -f "apps/api/prisma.config.ts" ]; then
    echo "‚ùå ‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå prisma.config.ts ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£! ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á..."
    rm apps/api/prisma.config.ts
else
    echo "‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå prisma.config.ts (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)"
fi

# ========================================
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 6: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Environment Variables
# ========================================
echo ""
echo "üìù [6/10] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .env..."

# ‡∏™‡∏£‡πâ‡∏≤‡∏á .env ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API
cat > apps/api/.env << 'ENV'
DATABASE_URL="postgresql://lottery_user:lottery_pass_2024@localhost:5432/lottery_db"
NODE_ENV=production
JWT_SECRET=your_super_secret_jwt_key_2024
PORT=3001
FRONTEND_URL=http://76.13.18.170
API_URL=http://76.13.18.170/api
ENV

# ‡∏™‡∏£‡πâ‡∏≤‡∏á .env ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Web
cat > apps/web/.env.local << 'ENV'
NEXT_PUBLIC_API_URL=/api
ENV
echo "‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .env ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"

# ========================================
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 7: ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies
# ========================================
echo ""
echo "üì¶ [7/10] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á dependencies (‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)..."
npm install

# ========================================
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 8: Prisma Setup ‡πÅ‡∏•‡∏∞ Build
# ========================================
echo ""
echo "üî® [8/10] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Prisma..."
export DATABASE_URL="postgresql://lottery_user:lottery_pass_2024@localhost:5432/lottery_db"

cd apps/api
echo "  ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á generate Prisma Client..."
npx prisma generate

echo "  ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á push schema ‡πÑ‡∏õ‡∏¢‡∏±‡∏á database..."
npx prisma db push --accept-data-loss

echo "  ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á build API..."
npm run build

cd ../web
echo "  ‚Üí ‡∏Å‡∏≥‡∏•‡∏±‡∏á build Web..."
npm run build
echo "‚úÖ Build ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"

# ========================================
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 9: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Services ‡∏î‡πâ‡∏ß‡∏¢ PM2
# ========================================
echo ""
echo "üöÄ [9/10] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô services..."

cd /var/www/lottery/apps/api
pm2 start dist/src/main.js --name lottery-api

cd /var/www/lottery/apps/web
pm2 start npm --name lottery-web -- start

pm2 save
echo "‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô services ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"

# ========================================
# ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 10: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö
# ========================================
echo ""
echo "‚è≥ [10/10] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ services ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô..."
sleep 10

echo ""
echo "=========================================="
echo "‚úÖ ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!"
echo "=========================================="
echo ""
echo "üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PM2 Services:"
pm2 list
echo ""
echo "=========================================="
echo "üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API:"
echo "=========================================="
curl -s http://localhost:3001/api | head -20 || echo "‚ö†Ô∏è  API ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö"
echo ""
echo "=========================================="
echo "üìã API Logs (20 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î):"
echo "=========================================="
pm2 logs lottery-api --lines 20 --nostream
echo ""
echo "=========================================="
echo "üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà:"
echo "   üëâ http://76.13.18.170"
echo "=========================================="
DEPLOYEOF
