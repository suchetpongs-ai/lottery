// SQLite Compatible Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ========================================
// Users & Auth
// ========================================

model User {
  id          Int      @id @default(autoincrement())
  username    String   @unique
  phoneNumber String   @unique @map("phone_number")
  passwordHash String   @map("password_hash")
  role        String   @default("USER") // Enum: USER, ADMIN, SUPER_ADMIN
  kycStatus   String   @default("Unverified") @map("kyc_status") // Enum: Unverified, Pending, Verified, Rejected
  kycInfo     String?  @map("kyc_info") // JSON string: { idCardImage, selfieImage, address, submittedAt }
  
  // Email verification
  emailVerified Boolean  @default(false) @map("email_verified")
  email       String?  @unique

  // Relations
  orders      Order[]
  payments    Payment[]
  claims      Claim[]
  wishlist    Wishlist[]
  notifications Notification[]
  auditLogs   AuditLog[]

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("users")
}

// ========================================
// Lottery Core
// ========================================

model Round {
  id              Int      @id @default(autoincrement())
  name            String?
  drawDate        DateTime @map("draw_date")
  openSellingAt   DateTime @map("open_selling_at")
  closeSellingAt  DateTime @map("close_selling_at")
  
  ticketPrice     Decimal  @default(80.00) @map("ticket_price")
  status          String   @default("UPCOMING") // Enum: UPCOMING, OPEN, CLOSED, DRAWN, ARCHIVED
  
  totalTickets    Int      @default(0) @map("total_tickets")
  soldTickets     Int      @default(0) @map("sold_tickets")

  // Prize configuration
  prizeConfig     String?  @map("prize_config") // JSON string: { firstPrize: 6000000, ... }

  // Prize announcement fields
  winningNumbers  String?  @map("winning_numbers") // JSON string: { firstPrize: ["123456"], ... }
  resultsAnnouncedAt DateTime? @map("results_announced_at")

  // Relations
  tickets         Ticket[]

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("rounds")
}

model Ticket {
  id              BigInt   @id @default(autoincrement()) // LibSQL/SQLite might need handling for BigInt
  roundId         Int      @map("round_id")
  number          String   // 6 digits
  price           Decimal
  
  status          String   @default("Available") // Enum: Available, Reserved, Sold, Cancelled
  
  // Group/Set info
  setSize         Int      @default(1) @map("set_size") // 1, 2, 5, etc.
  imageUrl        String?  @map("image_url")

  // Prize checking status
  prizeAmount     Decimal? @default(0) @map("prize_amount")
  prizeTier       String?  @map("prize_tier")  // e.g. "FirstPrize", "ThreeDigitSuffix"
  prizeCheckedAt  DateTime? @map("prize_checked_at")

  // Relations
  round           Round    @relation(fields: [roundId], references: [id])
  orderItems      OrderItem[]
  cartItems       CartItem[] // Added relation to CartItem
  claims          Claim[]

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([roundId, number, setSize]) // Allow duplicate numbers if different set sizes (optional)
  @@index([status])
  @@index([number])
  @@map("tickets")
}

model CartItem {
    id        Int      @id @default(autoincrement())
    userId    Int      @map("user_id") // Optional: if we want persistent carts for logged in users
    ticketId  BigInt   @map("ticket_id")
    addedAt   DateTime @default(now()) @map("added_at")

    ticket    Ticket   @relation(fields: [ticketId], references: [id])
    
    @@map("cart_items")
}


// ========================================
// Orders & Payment
// ========================================

model Order {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  totalAmount     Decimal  @map("total_amount")
  status          String   @default("Pending") // Enum: Pending, Paid, Cancelled, Expired, Refunded
  
  expireAt        DateTime @map("expire_at")
  
  // Payment info
  paymentMethod   String?  @map("payment_method") // Enum: PromptPay, CreditCard, BankTransfer, Wallet

  // Relations
  user            User     @relation(fields: [userId], references: [id])
  items           OrderItem[]
  payments        Payment[]

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("orders")
}

model OrderItem {
  id          Int      @id @default(autoincrement())
  orderId     Int      @map("order_id")
  ticketId    BigInt   @map("ticket_id")
  price       Decimal

  order       Order    @relation(fields: [orderId], references: [id])
  ticket      Ticket   @relation(fields: [ticketId], references: [id])

  @@map("order_items")
}

model Payment {
  id              Int      @id @default(autoincrement())
  orderId         Int      @map("order_id")
  userId          Int      @map("user_id")
  amount          Decimal
  method          String   // Enum: PromptPay, CreditCard, ...
  status          String   @default("Pending") // Enum: Pending, Success, Failed, Cancelled, Refunded

  // Gateway info
  gatewayRefId    String?   @map("gateway_ref_id") // Ref จากธนาคาร
  gatewayResponse String?   @map("gateway_response") // JSON string
  qrPayload       String?   @map("qr_payload")
  
  paidAt          DateTime? @map("paid_at")

  order           Order     @relation(fields: [orderId], references: [id])
  user            User      @relation(fields: [userId], references: [id])

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("payments")
}

// ========================================
// การเรียกเงินรางวัล (Claims)
// ========================================
model Claim {
  id              BigInt    @id @default(autoincrement())
  claimNumber     String?   @unique @map("claim_number")
  
  ticketId        BigInt    @map("ticket_id")
  userId          Int       @map("user_id")
  
  amount          Decimal
  status          String   @default("PENDING") // Enum: PENDING, APPROVED, PAID, REJECTED // PENDING, APPROVED, REJECTED, PAID
  
  // Payment info for claim
  paymentMethod   String?   @map("payment_method")
  bankName        String?   @map("bank_name")
  bankAccount     String?   @map("bank_account")
  
  // Processing
  claimedAt       DateTime  @default(now()) @map("claimed_at")
  processedAt     DateTime? @map("processed_at")
  processedBy     Int?      @map("processed_by")
  rejectionReason String?   @map("rejection_reason")
  
  // Documents
  documents       String? // JSON string

  user            User     @relation(fields: [userId], references: [id])
  ticket          Ticket   @relation(fields: [ticketId], references: [id])

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("claims")
}

// ========================================
// User Features
// ========================================

model Wishlist {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  number    String   // The number they want
  
  notified  Boolean  @default(false)

  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("wishlists")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  title     String
  message   String
  type      String   // info, win, system, payment
  read      Boolean  @default(false)
  
  // Link to related entity
  referenceId String? @map("reference_id")
  referenceType String? @map("reference_type")

  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

// ========================================
// System & Audit
// ========================================

model SystemConfig {
  key         String   @id
  value       String
  description String?

  updatedAt   DateTime @updatedAt
  
  @@map("system_configs")
}

model Analytics {
  id        Int      @id @default(autoincrement())
  date      DateTime
  metric    String   // e.g. daily_sales, active_users
  value     Decimal
  metadata  String?  // JSON string

  @@unique([date, metric])
  @@map("analytics")
}

// ========================================
model AuditLog {
  id        BigInt   @id @default(autoincrement())
  
  userId    Int?     @map("user_id") // Null for system actions
  action    String   // "user.ban", "round.create"
  resource  String   // "User", "Round"
  resourceId String? @map("resource_id")
  
  changes   String?  // JSON string: { before: {...}, after: {...} }
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  user User? @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
