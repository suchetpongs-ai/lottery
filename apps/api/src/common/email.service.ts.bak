import { Injectable } from '@nestjs/common';
import * as nodemailer from 'nodemailer';
import { ConfigService } from '@nestjs/config';

export interface EmailOptions {
    to: string;
    subject: string;
    text?: string;
    html?: string;
}

@Injectable()
export class EmailService {
    private transporter: nodemailer.Transporter;

    constructor(private configService: ConfigService) {
        // Initialize email transporter
        // For development, you can use ethereal.email (free test email service)
        // For production, use SendGrid, AWS SES, or Mailgun

        this.transporter = nodemailer.createTransporter({
            host: this.configService.get('EMAIL_HOST') || 'smtp.gmail.com',
            port: this.configService.get('EMAIL_PORT') || 587,
            secure: false,
            auth: {
                user: this.configService.get('EMAIL_USER'),
                pass: this.configService.get('EMAIL_PASSWORD'),
            },
        });
    }

    async sendEmail(options: EmailOptions): Promise<void> {
        try {
            await this.transporter.sendMail({
                from: this.configService.get('EMAIL_FROM') || 'noreply@lottery.com',
                to: options.to,
                subject: options.subject,
                text: options.text,
                html: options.html,
            });
            console.log(`Email sent to ${options.to}`);
        } catch (error) {
            console.error('Failed to send email:', error);
            // Don't throw error - email failure shouldn't break the application
        }
    }

    // Template methods for specific emails
    async sendWelcomeEmail(email: string, username: string) {
        await this.sendEmail({
            to: email,
            subject: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏≤‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå',
            html: `
        <h1>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${username}!</h1>
        <p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤</p>
        <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!</p>
      `,
        });
    }

    async sendPrizeWinEmail(email: string, ticketNumber: string, prizeAmount: number, prizeTier: string) {
        await this.sendEmail({
            to: email,
            subject: 'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•!',
            html: `
        <h1>üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</h1>
        <p>‡∏™‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç <strong>${ticketNumber}</strong> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å${prizeTier}</p>
        <h2>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ‡∏ø${prizeAmount.toLocaleString()}</h2>
        <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</p>
        <a href="${this.configService.get('WEB_URL')}/my-prizes">‡∏î‡∏π‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</a>
      `,
        });
    }

    async sendClaimApprovedEmail(email: string, ticketNumber: string, amount: number) {
        await this.sendEmail({
            to: email,
            subject: '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏•‡πâ‡∏ß',
            html: `
        <h1>‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß!</h1>
        <p>‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏•‡∏≤‡∏Å ${ticketNumber}</p>
        <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ‡∏ø${amount.toLocaleString()}</p>
        <p>‡∏à‡∏∞‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3-5 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</p>
      `,
        });
    }

    async sendClaimRejectedEmail(email: string, ticketNumber: string, reason: string) {
        await this.sendEmail({
            to: email,
            subject: '‚ùå ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò',
            html: `
        <h1>‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</h1>
        <p>‡∏™‡∏•‡∏≤‡∏Å: ${ticketNumber}</p>
        <p>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${reason}</p>
        <p>‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
      `,
        });
    }

    async sendNewRoundEmail(email: string, roundName: string) {
        await this.sendEmail({
            to: email,
            subject: 'üé∞ ‡∏á‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!',
            html: `
        <h1>üé∞ ‡∏á‡∏ß‡∏î‡πÉ‡∏´‡∏°‡πà!</h1>
        <p>${roundName} ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</p>
        <p>‡∏£‡∏µ‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î!</p>
        <a href="${this.configService.get('WEB_URL')}/browse">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏•‡∏≤‡∏Å</a>
      `,
        });
    }
}
